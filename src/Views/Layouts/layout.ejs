<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple backend</title>
</head>
<body>
    <!-- form to post product -->
    <h1>Save a product</h1>
    <!-- <form action="/products" method="POST" enctype="application/x-www-form-urlencoded"> -->
    <form id="form">
        <input type="text" name="title" placeholder="Title"><br><br>
        <input type="text" name="price" placeholder="Price"><br><br>
        <input type="text" name="thumbnail" placeholder="Thumbnail url"><br><br>
        <input type="submit" value="submit">
    </form>

    <!-- table to show products -->
    <h1>Products</h1>
    <% if(products.length > 0) { %>
        <table>
            <thead>
                <tr>
                    <th style="padding: 10px;">Id</th>
                    <th style="padding: 10px;">Title</th>
                    <th style="padding: 10px;">Price</th>
                    <th style="padding: 10px;">Thumbnail</th>
                </tr>
            </thead>
            <tbody>
                <% products.forEach(function(product) { %>
                    <tr>
                        <td style="padding: 10px;"><%= product.id %></td>
                        <td style="padding: 10px;"><%= product.title %></td>
                        <td style="padding: 10px;"><%= product.price %></td>
                        <td style="padding: 10px;"><img src=<%= product.thumbnail %>></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } else { %>
        <p>No products</p>
    <% } %>

    <!-- Clients chat -->
    <h1>Clients chat</h1>
    <div id="messagesContainer"></div>
    <form id="chatForm">
        <input type="text" name="email" placeholder="email">
        <input type="text" name="message" placeholder="Message"><br><br>
        <input type="submit" value="submit">
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io()
        let form = document.getElementById('form')
        form.addEventListener('submit', function(e) {
            e.preventDefault()
            let formData = new FormData(form)
            let data = {}
            formData.forEach(function(value, key) {
                data[key] = value
            })
            socket.emit('product', data)
        })
        socket.on('updatedProducts', () => {
            location.reload()
        })

        let chatMessages = []
        let chatForm = document.getElementById('chatForm')
        let messagesContainer = document.getElementById('messagesContainer')
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault()
            let formData = new FormData(chatForm)
            let data = {}
            formData.forEach(function(value, key) {
                data[key] = value
            })
            if(data.email && data.message) {
                socket.emit('message', data)
            } else {
                console.error('Email and message are required')
            }
        })

        socket.on('updatedChat', (data) => {
            chatMessages = data
            messagesContainer.innerHTML = ''
            chatMessages.forEach(function(message) {
                const date = new Date(message.date)
                let div = document.createElement('div')
                div.style.padding = '5px'
                div.innerHTML = `<b style="color: blue;">${message.email}</b> 
                                <span style="color: brown;">[${date.getDate()}/${date.getMonth()}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}]:</span>
                                <em style="color: green;"> ${message.message}</em>`
                messagesContainer.appendChild(div)
            })
        })
    </script>
</body>
</html>